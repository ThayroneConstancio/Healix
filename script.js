// Objeto de Tradu√ß√£o Central
const translations = {
    "pt-BR": {
        "title": "HEALIX - G√™meo Digital de Sa√∫de Preditiva",
        "nav_gds": "G√™meo Digital",
        "nav_nexus": "M√©dicos (Nexus)",
        "nav_simulation": "Laborat√≥rio Preditivo",
        "auth_button_login": "Entrar",
        "auth_button_logout": "Sair",
        "h2_gds": "Seu G√™meo Digital de Sa√∫de (GDS)",
        "score_label": "N√≠vel de Resili√™ncia",
        "alert_title": "üî¥ ALERTA DE RISCO PREDITIVO (ORACLE)",
        "alert_default": "Aguardando dados...",
        "alert_button": "Iniciar Micro-Consulta Autom√°tica",
        "h3_journey": "Sua Jornada de Cuidado Ativo",
        "mission1_title": "Miss√£o 1: Sono Profundo (3/7 dias conclu√≠dos)",
        "mission2_title": "Miss√£o 2: Atividade Cardiovascular (Recompensa: üíé)",
        "journey_rewards_button": "Ver Recompensas", 
        "alert_message_high_risk": "Queda na qualidade do sono (m√©dia de 4h) + pico de polui√ß√£o local. Risco Moderado de Crise Respirat√≥ria em 48h.",
        "micro_consulta_alert": "Iniciando Micro-Consulta Autom√°tica com Especialista em 30 segundos. Dados preditivos enviados ao m√©dico!",
        "rewards_alert": "Parab√©ns! Voc√™ desbloqueou a Masterclass 'Melhore seu Sono' e o Treinamento de Resili√™ncia Mental.", 
        "ping_alert": "EMERGENCY PING ATIVADO: Localizando o recurso de sa√∫de mais pr√≥ximo e enviando seus dados vitais de Blockchain. Mantenha-se conectado!",
        "form_login_title": "Entrar na HEALIX",
        "form_login_submit": "Entrar",
        "form_login_switch": "N√£o tem conta? Cadastre-se",
        "form_register_title": "Cadastre-se",
        "form_register_submit": "Criar Conta",
        "form_register_switch": "J√° tem conta? Entrar",
        "form_register_dob_placeholder": "Data de Nascimento",
        "save_activity": "Salvar Atividade",
        "save_success": "Atividade '{activity}' salva com sucesso em seu G√™meo Digital!",
        "save_error_login": "Fa√ßa login ou cadastre-se para salvar suas atividades.",
        // Feed de Not√≠cias
        "feed_title": "‚ö° INTELLIGENCE HEALIX: Sa√∫de Global em Tempo Real",
        "feed_item1_title": "Nova variante de gripe identificada na √Åsia.",
        "feed_item1_desc": "O Oracle Global alerta para monitoramento respirat√≥rio em √°reas urbanas.",
        "feed_item2_title": "Relat√≥rio mostra impacto do calor na sa√∫de mental.",
        "feed_item2_desc": "Popula√ß√µes na Europa Oriental enfrentam risco elevado de estresse t√©rmico.",
        "feed_item3_title": "Avan√ßo na IA para diagn√≥stico precoce de c√¢ncer.",
        "feed_item3_desc": "Estudo do MIT valida modelo preditivo com 98% de acur√°cia.",
        // Se√ß√£o Nexus
        "nexus_h2": "NEXUS: Sua Conex√£o Direta com Especialistas",
        "nexus_card1_title": "Telemetria M√©dica Preditiva",
        "nexus_card1_desc": "Compartilhe insights preditivos do seu GDS com seu m√©dico de confian√ßa em tempo real. A HEALIX torna as consultas mais eficientes e proativas.",
        "nexus_card2_title": "Encontre seu Especialista de IA",
        "nexus_card2_desc": "Procure por m√©dicos certificados no ecossistema HEALIX. Eles s√£o treinados para interpretar os dados avan√ßados do seu G√™meo Digital.",
        "nexus_button": "Acessar Painel Nexus",
        // Laborat√≥rio de Simula√ß√£o (Atualizado - Chaves Gen√©ricas)
        "lab_h2": "LABORAT√ìRIO PREDITIVO: Simula√ß√£o de Cen√°rios",
        "lab_desc": "Execute simula√ß√µes para ver como mudan√ßas de comportamento impactam seu N√≠vel de Resili√™ncia. (Ex: 'Correr 3x', 'Comer Fast Food')",
        "sim_h3_input": "Cen√°rio de An√°lise",
        "sim_h3_result": "Resultado Projetado",
        "sim_label_score": "Novo N√≠vel de Resili√™ncia",
        "sim_label_duration": "Per√≠odo de Proje√ß√£o:",
        "sim_label_intensity": "Frequ√™ncia/Intensidade (Dias/Semana):",
        "sim_message_default": "O resultado da simula√ß√£o aparecer√° aqui.",
        "sim_button": "Executar Simula√ß√£o",
        "sim_res_positive": "Ganho de Resili√™ncia! Proje√ß√£o para {score} em {duration} meses. Sua consist√™ncia est√° promovendo sa√∫de e longevidade.",
        "sim_res_negative": "Risco Elevado! Proje√ß√£o para {score} em {duration} meses. Seu GDS alerta para a necessidade de corre√ß√£o comportamental.",
        "sim_res_neutral": "Efeito Neutro. Proje√ß√£o para {score} em {duration} meses. O impacto deste comportamento √© marginal ou foi compensado por outros fatores.",
        "sim_res_unknown": "Cen√°rio n√£o reconhecido. Proje√ß√£o para {score} em {duration} meses. O Oracle n√£o possui dados para esta simula√ß√£o.",
    },
    "en-US": {
        "title": "HEALIX - Predictive Digital Twin Health",
        "nav_gds": "Digital Twin",
        "nav_nexus": "Doctors (Nexus)",
        "nav_simulation": "Predictive Lab",
        "auth_button_login": "Login",
        "auth_button_logout": "Logout",
        "h2_gds": "Your Digital Health Twin (GDS)",
        "score_label": "Resilience Level",
        "alert_title": "üî¥ PREDICTIVE RISK ALERT (ORACLE)",
        "alert_default": "Awaiting data...",
        "alert_button": "Start Automatic Micro-Consultation",
        "h3_journey": "Your Active Care Journey",
        "mission1_title": "Mission 1: Deep Sleep (3/7 days completed)",
        "mission2_title": "Mission 2: Cardiovascular Activity (Reward: üíé)",
        "journey_rewards_button": "View Rewards",
        "alert_message_high_risk": "Drop in sleep quality (4h avg) + local pollution peak. Moderate Risk of Respiratory Crisis within 48h.",
        "micro_consulta_alert": "Initiating Automatic Micro-Consultation with Specialist in 30 seconds. Predictive data sent to the doctor!",
        "rewards_alert": "Congratulations! You unlocked the 'Improve Your Sleep' Masterclass and Mental Resilience Training.", 
        "ping_alert": "EMERGENCY PING ACTIVATED: Locating the nearest health resource and sending your Blockchain vital data. Stay connected!",
        "form_login_title": "Log in to HEALIX",
        "form_login_submit": "Log In",
        "form_login_switch": "Don't have an account? Register",
        "form_register_title": "Register",
        "form_register_submit": "Create Account",
        "form_register_switch": "Already have an account? Log In",
        "form_register_dob_placeholder": "Date of Birth",
        "save_activity": "Save Activity",
        "save_success": "Activity '{activity}' successfully saved to your Digital Twin!",
        "save_error_login": "Please log in or register to save your activities.",
        // Feed de Not√≠cias
        "feed_title": "‚ö° INTELLIGENCE HEALIX: Real-Time Global Health",
        "feed_item1_title": "New flu variant identified in Asia.",
        "feed_item1_desc": "Global Oracle alerts for respiratory monitoring in urban areas.",
        "feed_item2_title": "Report shows impact of heat on mental health.",
        "feed_item2_desc": "Populations in Eastern Europe face elevated heat stress risk.",
        "feed_item3_title": "Breakthrough in AI for early cancer diagnosis.",
        "feed_item3_desc": "MIT study validates predictive model with 98% accuracy.",
        // Se√ß√£o Nexus
        "nexus_h2": "NEXUS: Your Direct Connection to Specialists",
        "nexus_card1_title": "Predictive Medical Telemetry",
        "nexus_card1_desc": "Share predictive insights from your GDS with your trusted physician in real-time. HEALIX makes consultations more efficient and proactive.",
        "nexus_card2_title": "Find Your AI Specialist",
        "nexus_card2_desc": "Search for certified doctors in the HEALIX ecosystem. They are trained to interpret your Digital Twin's advanced data.",
        "nexus_button": "Access Nexus Dashboard",
        // Laborat√≥rio de Simula√ß√£o (Atualizado - Chaves Gen√©ricas)
        "lab_h2": "PREDICTIVE LAB: Scenario Simulation",
        "lab_desc": "Run simulations to see how behavior changes impact your Resilience Level. (Ex: 'Run 3x', 'Eat Fast Food')",
        "sim_h3_input": "Analysis Scenario",
        "sim_h3_result": "Projected Result",
        "sim_label_score": "New Resilience Level",
        "sim_label_duration": "Projection Period:",
        "sim_label_intensity": "Frequency/Intensity (Days/Week):",
        "sim_message_default": "Simulation result will appear here.",
        "sim_button": "Run Simulation",
        "sim_res_positive": "Resilience Gain! Projected to {score} in {duration} months. Your consistency is promoting health and longevity.",
        "sim_res_negative": "Elevated Risk! Projected to {score} in {duration} months. Your GDS warns of the need for behavioral correction.",
        "sim_res_neutral": "Neutral Effect. Projected to {score} in {duration} months. The impact of this behavior is marginal or has been offset by other factors.",
        "sim_res_unknown": "Unrecognized Scenario. Projected to {score} in {duration} months. The Oracle does not have data for this simulation.",
    }
};

let currentLanguage = 'pt-BR';
let isAuthenticated = false;

// O Score Base (Inicial) do GDS (Usado para a simula√ß√£o)
const BASE_GDS_SCORE = 92;

// --- L√ìGICA DO GDS (RISCO INICIAL) ---
const simulatedOracleData = {
    riskLevel: 'medium', 
    score: BASE_GDS_SCORE, // Usando a pontua√ß√£o base
    alertActive: true, 
    alertKey: 'alert_message_high_risk', 
};

// --- FUN√á√ïES DE TRADU√á√ÉO ---

function changeLanguage(lang) {
    currentLanguage = lang;
    const elements = document.querySelectorAll('[data-key]');
    const t = translations[lang];

    elements.forEach(element => {
        const key = element.getAttribute('data-key');
        if (t[key]) {
            // Se for um <select> ou <option>, o tratamento √© diferente
            if (element.tagName === 'OPTION' && element.parentElement.id === 'simulation-duration') {
                // Deixa as options de dura√ß√£o (3 meses, 6 meses...) em paz ou traduz se necess√°rio
            } else if (element.tagName === 'TITLE') {
                 document.title = t[key];
            } else {
                 element.textContent = t[key];
            }
        }
    });

    // Atualiza o conte√∫do din√¢mico ap√≥s mudar o idioma
    updateGDS(simulatedOracleData);
    updateAuthButton();
    loadGlobalFeed(currentLanguage); 
    // Garante que a mensagem de simula√ß√£o tamb√©m seja traduzida
    document.getElementById('sim-message').textContent = t['sim_message_default'];
}

// --- FUN√á√ïES DE AUTENTICA√á√ÉO, SAVE ACTIVITY e UPDATE GDS (Sem altera√ß√µes significativas) ---

function updateAuthButton() {
    const authButton = document.getElementById('auth-button');
    const t = translations[currentLanguage];
    if (isAuthenticated) {
        authButton.textContent = t['auth_button_logout'];
        authButton.onclick = logout;
    } else {
        authButton.textContent = t['auth_button_login'];
        authButton.onclick = () => showAuthModal('login');
    }
}

function showAuthModal(formType) {
    const modal = document.getElementById('auth-modal');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    if (isAuthenticated) return logout();

    modal.classList.remove('modal-hidden');
    
    if (formType === 'login') {
        loginForm.classList.remove('form-hidden');
        registerForm.classList.add('form-hidden');
    } else {
        loginForm.classList.add('form-hidden');
        registerForm.classList.remove('form-hidden');
    }
}

function hideAuthModal() {
    document.getElementById('auth-modal').classList.add('modal-hidden');
}

function login(e) {
    e.preventDefault();
    isAuthenticated = true;
    hideAuthModal();
    updateAuthButton();
    alert(`Bem-vindo de volta, G√™meo Digital pronto para voc√™!`);
}

function register(e) {
    e.preventDefault();
    isAuthenticated = true;
    hideAuthModal();
    updateAuthButton();
    alert(`Conta HEALIX criada com sucesso! Conectando G√™meo Digital...`);
}

function logout() {
    isAuthenticated = false;
    updateAuthButton();
    alert('Voc√™ foi desconectado da HEALIX.');
}

function saveActivity(activityName) {
    const t = translations[currentLanguage];
    if (!isAuthenticated) {
        alert(t['save_error_login']);
        showAuthModal('login');
        return;
    }

    const successMessage = t['save_success'].replace('{activity}', activityName);
    alert(successMessage);
}


function updateGDS(data) {
    const t = translations[currentLanguage];
    const healthSphere = document.getElementById('health-sphere');
    const oracleAlert = document.getElementById('oracle-alert'); 

    document.getElementById('health-score').textContent = data.score;
    
    healthSphere.className = ''; 
    healthSphere.classList.add(`risk-${data.riskLevel}`);
    
    if (data.alertActive) {
        oracleAlert.classList.remove('alert-hidden');
        document.getElementById('alert-message').textContent = t[data.alertKey]; 
        
        if (data.riskLevel === 'high') {
            healthSphere.style.animation = 'pulse 1s infinite';
        } else {
            healthSphere.style.animation = 'none';
        }
    } else {
        oracleAlert.classList.add('alert-hidden');
        healthSphere.style.animation = 'none';
    }
}

// --- FUN√á√ÉO LABORAT√ìRIO DE SIMULA√á√ÉO OTIMIZADA POR PALAVRAS-CHAVE ---
function runSimulation() {
    // Agora l√™ do novo campo de texto
    const scenarioText = document.getElementById('simulation-scenario-input').value.toLowerCase();
    const duration = parseInt(document.getElementById('simulation-duration').value); 
    const intensity = parseInt(document.getElementById('simulation-intensity').value); 
    
    const simScoreEl = document.getElementById('sim-projected-score');
    const simMessageEl = document.getElementById('sim-message');
    const t = translations[currentLanguage];
    
    let projectedScore = BASE_GDS_SCORE;
    let messageKey = 'sim_res_unknown'; 
    let riskClass = 'sim-risk-low';
    let impactFactor = 0; // Impacto base por m√™s

    if (!isAuthenticated) {
        alert(t['save_error_login']);
        return;
    }
    if (scenarioText.trim() === '' || isNaN(intensity) || intensity < 1 || intensity > 7) {
        alert("Por favor, descreva um cen√°rio e defina uma intensidade v√°lida (1-7).");
        return;
    }

    // L√≥gica de An√°lise de Palavras-Chave (Processamento de Linguagem Natural Simplificado)
    
    // Fator que modula o impacto pela frequ√™ncia (ex: se for 7 dias/semana, √© 1. Se for 3 dias/semana, √© 0.42)
    const normalizedIntensity = intensity / 7; 

    // Cen√°rios de RISCO (Impacto Negativo)
    if (scenarioText.includes('dormir') && (scenarioText.includes('5h') || scenarioText.includes('4h') || scenarioText.includes('pouco'))) {
        // Sono ruim (custo alto)
        impactFactor = -1.5 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } else if (scenarioText.includes('sal') || scenarioText.includes('sodio') || scenarioText.includes('refrigerante')) 
     {
        // Sal/S√≥dio Alto ou a√ß√∫cares l√≠quidos (risco cardiovascular/metab√≥lico)
        impactFactor = -1.2 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } else if (scenarioText.includes('fast food') || scenarioText.includes('processado') || scenarioText.includes('fritura')) {
        // Junk food (risco inflamat√≥rio)
        impactFactor = -0.9 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } 
    // Cen√°rios de OTIMIZA√á√ÉO (Impacto Positivo)
    else if (scenarioText.includes('correr') || scenarioText.includes('cardio') || scenarioText.includes('caminhar') || scenarioText.includes('malhar')) {
        // Atividade Cardiovascular/For√ßa (ganho mais significativo)
        impactFactor = 1.0 * normalizedIntensity; 
        messageKey = 'sim_res_positive';
    } else if (scenarioText.includes('√°gua') || scenarioText.includes('hidratar')) {
        // Hidrata√ß√£o (benef√≠cio moderado, independente da frequ√™ncia de "beber" j√° que a meta √© di√°ria)
        impactFactor = 0.5; 
        messageKey = 'sim_res_positive';
    } else if (scenarioText.includes('meditar') || scenarioText.includes('yoga') || scenarioText.includes('ler')) {
        // Sa√∫de Mental / Cognitiva (benef√≠cio)
        impactFactor = 0.7 * normalizedIntensity;
        messageKey = 'sim_res_positive';
    } 

    // Se o impacto for zero e n√£o for uma palavra-chave conhecida, ou se a palavra-chave √© neutra
    if (impactFactor === 0 && messageKey === 'sim_res_unknown') {
        if (scenarioText.includes('mudar nada') || scenarioText.includes('igual') || scenarioText.includes('manter')) {
             impactFactor = 0;
             messageKey = 'sim_res_neutral';
        } else {
             // Deixa como desconhecido
        }
    }
    
    // O impacto total √© o fator multiplicado pela dura√ß√£o em meses.
    const totalImpact = impactFactor * duration;
    projectedScore = Math.round(BASE_GDS_SCORE + totalImpact);

    // Limita a pontua√ß√£o entre 0 e 100
    projectedScore = Math.max(0, Math.min(100, projectedScore));

    // Determina a classe de risco com base na pontua√ß√£o final
    if (projectedScore < 75) {
        riskClass = 'sim-risk-high';
    } else if (projectedScore < 90) {
        riskClass = 'sim-risk-medium';
    } else {
        riskClass = 'sim-risk-low';
    }

    // Atualiza a mensagem com os valores din√¢micos
    let finalMessage = t[messageKey]
        .replace('{score}', projectedScore)
        .replace('{duration}', duration);

    // Atualiza a interface
    simScoreEl.textContent = projectedScore;
    simScoreEl.className = '';
    simScoreEl.classList.add(riskClass);
    simMessageEl.textContent = finalMessage;
}

// --- FUN√á√ïES COMPLEMENTARES ---
function loadGlobalFeed(lang) {
    const t = translations[lang];
    const feedContent = document.getElementById('feed-content');
    feedContent.innerHTML = ''; 

    const feedItems = [
        { title: t['feed_item1_title'], desc: t['feed_item1_desc'] },
        { title: t['feed_item2_title'], desc: t['feed_item2_desc'] },
        { title: t['feed_item3_title'], desc: t['feed_item3_desc'] },
    ];

    feedItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('feed-item');
        itemDiv.innerHTML = `
            <h4>${item.title}</h4>
            <p>${item.desc}</p>
        `;
        feedContent.appendChild(itemDiv);
    });
}


function handleMicroConsulta() {
    if (!isAuthenticated) return alert(translations[currentLanguage]['save_error_login']);
    alert(translations[currentLanguage]['micro_consulta_alert']);
    document.getElementById('oracle-alert').classList.add('alert-hidden'); 
}

function viewRewards() {
    alert(translations[currentLanguage]['rewards_alert']);
}

document.getElementById('emergencyPing').addEventListener('click', () => {
    alert(translations[currentLanguage]['ping_alert']);
});

// Inicializa√ß√£o da Plataforma
document.addEventListener('DOMContentLoaded', () => {
    // Adiciona os event listeners aos formul√°rios
    document.getElementById('login-form').addEventListener('submit', login);
    document.getElementById('register-form').addEventListener('submit', register);

    // Inicializa a interface
    changeLanguage(currentLanguage); 
    updateAuthButton();
});