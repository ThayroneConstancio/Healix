// Objeto de Tradução Central
const translations = {
    "pt-BR": {
        "title": "HEALIX - Gêmeo Digital de Saúde Preditiva",
        "nav_gds": "Gêmeo Digital",
        "nav_nexus": "Médicos (Nexus)",
        "nav_simulation": "Laboratório Preditivo",
        "auth_button_login": "Entrar",
        "auth_button_logout": "Sair",
        "h2_gds": "Seu Gêmeo Digital de Saúde (GDS)",
        "score_label": "Nível de Resiliência",
        "alert_title": "🔴 ALERTA DE RISCO PREDITIVO (ORACLE)",
        "alert_default": "Aguardando dados...",
        "alert_button": "Iniciar Micro-Consulta Automática",
        "h3_journey": "Sua Jornada de Cuidado Ativo",
        "mission1_title": "Missão 1: Sono Profundo (3/7 dias concluídos)",
        "mission2_title": "Missão 2: Atividade Cardiovascular (Recompensa: 💎)",
        "journey_rewards_button": "Ver Recompensas", 
        "alert_message_high_risk": "Queda na qualidade do sono (média de 4h) + pico de poluição local. Risco Moderado de Crise Respiratória em 48h.",
        "micro_consulta_alert": "Iniciando Micro-Consulta Automática com Especialista em 30 segundos. Dados preditivos enviados ao médico!",
        "rewards_alert": "Parabéns! Você desbloqueou a Masterclass 'Melhore seu Sono' e o Treinamento de Resiliência Mental.", 
        "ping_alert": "EMERGENCY PING ATIVADO: Localizando o recurso de saúde mais próximo e enviando seus dados vitais de Blockchain. Mantenha-se conectado!",
        "form_login_title": "Entrar na HEALIX",
        "form_login_submit": "Entrar",
        "form_login_switch": "Não tem conta? Cadastre-se",
        "form_register_title": "Cadastre-se",
        "form_register_submit": "Criar Conta",
        "form_register_switch": "Já tem conta? Entrar",
        "form_register_dob_placeholder": "Data de Nascimento",
        "save_activity": "Salvar Atividade",
        "save_success": "Atividade '{activity}' salva com sucesso em seu Gêmeo Digital!",
        "save_error_login": "Faça login ou cadastre-se para salvar suas atividades.",
        // Feed de Notícias
        "feed_title": "⚡ INTELLIGENCE HEALIX: Saúde Global em Tempo Real",
        "feed_item1_title": "Nova variante de gripe identificada na Ásia.",
        "feed_item1_desc": "O Oracle Global alerta para monitoramento respiratório em áreas urbanas.",
        "feed_item2_title": "Relatório mostra impacto do calor na saúde mental.",
        "feed_item2_desc": "Populações na Europa Oriental enfrentam risco elevado de estresse térmico.",
        "feed_item3_title": "Avanço na IA para diagnóstico precoce de câncer.",
        "feed_item3_desc": "Estudo do MIT valida modelo preditivo com 98% de acurácia.",
        // Seção Nexus
        "nexus_h2": "NEXUS: Sua Conexão Direta com Especialistas",
        "nexus_card1_title": "Telemetria Médica Preditiva",
        "nexus_card1_desc": "Compartilhe insights preditivos do seu GDS com seu médico de confiança em tempo real. A HEALIX torna as consultas mais eficientes e proativas.",
        "nexus_card2_title": "Encontre seu Especialista de IA",
        "nexus_card2_desc": "Procure por médicos certificados no ecossistema HEALIX. Eles são treinados para interpretar os dados avançados do seu Gêmeo Digital.",
        "nexus_button": "Acessar Painel Nexus",
        // Laboratório de Simulação (Atualizado - Chaves Genéricas)
        "lab_h2": "LABORATÓRIO PREDITIVO: Simulação de Cenários",
        "lab_desc": "Execute simulações para ver como mudanças de comportamento impactam seu Nível de Resiliência. (Ex: 'Correr 3x', 'Comer Fast Food')",
        "sim_h3_input": "Cenário de Análise",
        "sim_h3_result": "Resultado Projetado",
        "sim_label_score": "Novo Nível de Resiliência",
        "sim_label_duration": "Período de Projeção:",
        "sim_label_intensity": "Frequência/Intensidade (Dias/Semana):",
        "sim_message_default": "O resultado da simulação aparecerá aqui.",
        "sim_button": "Executar Simulação",
        "sim_res_positive": "Ganho de Resiliência! Projeção para {score} em {duration} meses. Sua consistência está promovendo saúde e longevidade.",
        "sim_res_negative": "Risco Elevado! Projeção para {score} em {duration} meses. Seu GDS alerta para a necessidade de correção comportamental.",
        "sim_res_neutral": "Efeito Neutro. Projeção para {score} em {duration} meses. O impacto deste comportamento é marginal ou foi compensado por outros fatores.",
        "sim_res_unknown": "Cenário não reconhecido. Projeção para {score} em {duration} meses. O Oracle não possui dados para esta simulação.",
    },
    "en-US": {
        "title": "HEALIX - Predictive Digital Twin Health",
        "nav_gds": "Digital Twin",
        "nav_nexus": "Doctors (Nexus)",
        "nav_simulation": "Predictive Lab",
        "auth_button_login": "Login",
        "auth_button_logout": "Logout",
        "h2_gds": "Your Digital Health Twin (GDS)",
        "score_label": "Resilience Level",
        "alert_title": "🔴 PREDICTIVE RISK ALERT (ORACLE)",
        "alert_default": "Awaiting data...",
        "alert_button": "Start Automatic Micro-Consultation",
        "h3_journey": "Your Active Care Journey",
        "mission1_title": "Mission 1: Deep Sleep (3/7 days completed)",
        "mission2_title": "Mission 2: Cardiovascular Activity (Reward: 💎)",
        "journey_rewards_button": "View Rewards",
        "alert_message_high_risk": "Drop in sleep quality (4h avg) + local pollution peak. Moderate Risk of Respiratory Crisis within 48h.",
        "micro_consulta_alert": "Initiating Automatic Micro-Consultation with Specialist in 30 seconds. Predictive data sent to the doctor!",
        "rewards_alert": "Congratulations! You unlocked the 'Improve Your Sleep' Masterclass and Mental Resilience Training.", 
        "ping_alert": "EMERGENCY PING ACTIVATED: Locating the nearest health resource and sending your Blockchain vital data. Stay connected!",
        "form_login_title": "Log in to HEALIX",
        "form_login_submit": "Log In",
        "form_login_switch": "Don't have an account? Register",
        "form_register_title": "Register",
        "form_register_submit": "Create Account",
        "form_register_switch": "Already have an account? Log In",
        "form_register_dob_placeholder": "Date of Birth",
        "save_activity": "Save Activity",
        "save_success": "Activity '{activity}' successfully saved to your Digital Twin!",
        "save_error_login": "Please log in or register to save your activities.",
        // Feed de Notícias
        "feed_title": "⚡ INTELLIGENCE HEALIX: Real-Time Global Health",
        "feed_item1_title": "New flu variant identified in Asia.",
        "feed_item1_desc": "Global Oracle alerts for respiratory monitoring in urban areas.",
        "feed_item2_title": "Report shows impact of heat on mental health.",
        "feed_item2_desc": "Populations in Eastern Europe face elevated heat stress risk.",
        "feed_item3_title": "Breakthrough in AI for early cancer diagnosis.",
        "feed_item3_desc": "MIT study validates predictive model with 98% accuracy.",
        // Seção Nexus
        "nexus_h2": "NEXUS: Your Direct Connection to Specialists",
        "nexus_card1_title": "Predictive Medical Telemetry",
        "nexus_card1_desc": "Share predictive insights from your GDS with your trusted physician in real-time. HEALIX makes consultations more efficient and proactive.",
        "nexus_card2_title": "Find Your AI Specialist",
        "nexus_card2_desc": "Search for certified doctors in the HEALIX ecosystem. They are trained to interpret your Digital Twin's advanced data.",
        "nexus_button": "Access Nexus Dashboard",
        // Laboratório de Simulação (Atualizado - Chaves Genéricas)
        "lab_h2": "PREDICTIVE LAB: Scenario Simulation",
        "lab_desc": "Run simulations to see how behavior changes impact your Resilience Level. (Ex: 'Run 3x', 'Eat Fast Food')",
        "sim_h3_input": "Analysis Scenario",
        "sim_h3_result": "Projected Result",
        "sim_label_score": "New Resilience Level",
        "sim_label_duration": "Projection Period:",
        "sim_label_intensity": "Frequency/Intensity (Days/Week):",
        "sim_message_default": "Simulation result will appear here.",
        "sim_button": "Run Simulation",
        "sim_res_positive": "Resilience Gain! Projected to {score} in {duration} months. Your consistency is promoting health and longevity.",
        "sim_res_negative": "Elevated Risk! Projected to {score} in {duration} months. Your GDS warns of the need for behavioral correction.",
        "sim_res_neutral": "Neutral Effect. Projected to {score} in {duration} months. The impact of this behavior is marginal or has been offset by other factors.",
        "sim_res_unknown": "Unrecognized Scenario. Projected to {score} in {duration} months. The Oracle does not have data for this simulation.",
    }
};

let currentLanguage = 'pt-BR';
let isAuthenticated = false;

// O Score Base (Inicial) do GDS (Usado para a simulação)
const BASE_GDS_SCORE = 92;

// --- LÓGICA DO GDS (RISCO INICIAL) ---
const simulatedOracleData = {
    riskLevel: 'medium', 
    score: BASE_GDS_SCORE, // Usando a pontuação base
    alertActive: true, 
    alertKey: 'alert_message_high_risk', 
};

// --- FUNÇÕES DE TRADUÇÃO ---

function changeLanguage(lang) {
    currentLanguage = lang;
    const elements = document.querySelectorAll('[data-key]');
    const t = translations[lang];

    elements.forEach(element => {
        const key = element.getAttribute('data-key');
        if (t[key]) {
            // Se for um <select> ou <option>, o tratamento é diferente
            if (element.tagName === 'OPTION' && element.parentElement.id === 'simulation-duration') {
                // Deixa as options de duração (3 meses, 6 meses...) em paz ou traduz se necessário
            } else if (element.tagName === 'TITLE') {
                 document.title = t[key];
            } else {
                 element.textContent = t[key];
            }
        }
    });

    // Atualiza o conteúdo dinâmico após mudar o idioma
    updateGDS(simulatedOracleData);
    updateAuthButton();
    loadGlobalFeed(currentLanguage); 
    // Garante que a mensagem de simulação também seja traduzida
    document.getElementById('sim-message').textContent = t['sim_message_default'];
}

// --- FUNÇÕES DE AUTENTICAÇÃO, SAVE ACTIVITY e UPDATE GDS (Sem alterações significativas) ---

function updateAuthButton() {
    const authButton = document.getElementById('auth-button');
    const t = translations[currentLanguage];
    if (isAuthenticated) {
        authButton.textContent = t['auth_button_logout'];
        authButton.onclick = logout;
    } else {
        authButton.textContent = t['auth_button_login'];
        authButton.onclick = () => showAuthModal('login');
    }
}

function showAuthModal(formType) {
    const modal = document.getElementById('auth-modal');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    if (isAuthenticated) return logout();

    modal.classList.remove('modal-hidden');
    
    if (formType === 'login') {
        loginForm.classList.remove('form-hidden');
        registerForm.classList.add('form-hidden');
    } else {
        loginForm.classList.add('form-hidden');
        registerForm.classList.remove('form-hidden');
    }
}

function hideAuthModal() {
    document.getElementById('auth-modal').classList.add('modal-hidden');
}

function login(e) {
    e.preventDefault();
    isAuthenticated = true;
    hideAuthModal();
    updateAuthButton();
    alert(`Bem-vindo de volta, Gêmeo Digital pronto para você!`);
}

function register(e) {
    e.preventDefault();
    isAuthenticated = true;
    hideAuthModal();
    updateAuthButton();
    alert(`Conta HEALIX criada com sucesso! Conectando Gêmeo Digital...`);
}

function logout() {
    isAuthenticated = false;
    updateAuthButton();
    alert('Você foi desconectado da HEALIX.');
}

function saveActivity(activityName) {
    const t = translations[currentLanguage];
    if (!isAuthenticated) {
        alert(t['save_error_login']);
        showAuthModal('login');
        return;
    }

    const successMessage = t['save_success'].replace('{activity}', activityName);
    alert(successMessage);
}


function updateGDS(data) {
    const t = translations[currentLanguage];
    const healthSphere = document.getElementById('health-sphere');
    const oracleAlert = document.getElementById('oracle-alert'); 

    document.getElementById('health-score').textContent = data.score;
    
    healthSphere.className = ''; 
    healthSphere.classList.add(`risk-${data.riskLevel}`);
    
    if (data.alertActive) {
        oracleAlert.classList.remove('alert-hidden');
        document.getElementById('alert-message').textContent = t[data.alertKey]; 
        
        if (data.riskLevel === 'high') {
            healthSphere.style.animation = 'pulse 1s infinite';
        } else {
            healthSphere.style.animation = 'none';
        }
    } else {
        oracleAlert.classList.add('alert-hidden');
        healthSphere.style.animation = 'none';
    }
}

// --- FUNÇÃO LABORATÓRIO DE SIMULAÇÃO OTIMIZADA POR PALAVRAS-CHAVE ---
function runSimulation() {
    // Agora lê do novo campo de texto
    const scenarioText = document.getElementById('simulation-scenario-input').value.toLowerCase();
    const duration = parseInt(document.getElementById('simulation-duration').value); 
    const intensity = parseInt(document.getElementById('simulation-intensity').value); 
    
    const simScoreEl = document.getElementById('sim-projected-score');
    const simMessageEl = document.getElementById('sim-message');
    const t = translations[currentLanguage];
    
    let projectedScore = BASE_GDS_SCORE;
    let messageKey = 'sim_res_unknown'; 
    let riskClass = 'sim-risk-low';
    let impactFactor = 0; // Impacto base por mês

    if (!isAuthenticated) {
        alert(t['save_error_login']);
        return;
    }
    if (scenarioText.trim() === '' || isNaN(intensity) || intensity < 1 || intensity > 7) {
        alert("Por favor, descreva um cenário e defina uma intensidade válida (1-7).");
        return;
    }

    // Lógica de Análise de Palavras-Chave (Processamento de Linguagem Natural Simplificado)
    
    // Fator que modula o impacto pela frequência (ex: se for 7 dias/semana, é 1. Se for 3 dias/semana, é 0.42)
    const normalizedIntensity = intensity / 7; 

    // Cenários de RISCO (Impacto Negativo)
    if (scenarioText.includes('dormir') && (scenarioText.includes('5h') || scenarioText.includes('4h') || scenarioText.includes('pouco'))) {
        // Sono ruim (custo alto)
        impactFactor = -1.5 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } else if (scenarioText.includes('sal') || scenarioText.includes('sodio') || scenarioText.includes('refrigerante')) 
     {
        // Sal/Sódio Alto ou açúcares líquidos (risco cardiovascular/metabólico)
        impactFactor = -1.2 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } else if (scenarioText.includes('fast food') || scenarioText.includes('processado') || scenarioText.includes('fritura')) {
        // Junk food (risco inflamatório)
        impactFactor = -0.9 * normalizedIntensity; 
        messageKey = 'sim_res_negative';
    } 
    // Cenários de OTIMIZAÇÃO (Impacto Positivo)
    else if (scenarioText.includes('correr') || scenarioText.includes('cardio') || scenarioText.includes('caminhar') || scenarioText.includes('malhar')) {
        // Atividade Cardiovascular/Força (ganho mais significativo)
        impactFactor = 1.0 * normalizedIntensity; 
        messageKey = 'sim_res_positive';
    } else if (scenarioText.includes('água') || scenarioText.includes('hidratar')) {
        // Hidratação (benefício moderado, independente da frequência de "beber" já que a meta é diária)
        impactFactor = 0.5; 
        messageKey = 'sim_res_positive';
    } else if (scenarioText.includes('meditar') || scenarioText.includes('yoga') || scenarioText.includes('ler')) {
        // Saúde Mental / Cognitiva (benefício)
        impactFactor = 0.7 * normalizedIntensity;
        messageKey = 'sim_res_positive';
    } 

    // Se o impacto for zero e não for uma palavra-chave conhecida, ou se a palavra-chave é neutra
    if (impactFactor === 0 && messageKey === 'sim_res_unknown') {
        if (scenarioText.includes('mudar nada') || scenarioText.includes('igual') || scenarioText.includes('manter')) {
             impactFactor = 0;
             messageKey = 'sim_res_neutral';
        } else {
             // Deixa como desconhecido
        }
    }
    
    // O impacto total é o fator multiplicado pela duração em meses.
    const totalImpact = impactFactor * duration;
    projectedScore = Math.round(BASE_GDS_SCORE + totalImpact);

    // Limita a pontuação entre 0 e 100
    projectedScore = Math.max(0, Math.min(100, projectedScore));

    // Determina a classe de risco com base na pontuação final
    if (projectedScore < 75) {
        riskClass = 'sim-risk-high';
    } else if (projectedScore < 90) {
        riskClass = 'sim-risk-medium';
    } else {
        riskClass = 'sim-risk-low';
    }

    // Atualiza a mensagem com os valores dinâmicos
    let finalMessage = t[messageKey]
        .replace('{score}', projectedScore)
        .replace('{duration}', duration);

    // Atualiza a interface
    simScoreEl.textContent = projectedScore;
    simScoreEl.className = '';
    simScoreEl.classList.add(riskClass);
    simMessageEl.textContent = finalMessage;
}

// --- FUNÇÕES COMPLEMENTARES ---
function loadGlobalFeed(lang) {
    const t = translations[lang];
    const feedContent = document.getElementById('feed-content');
    feedContent.innerHTML = ''; 

    const feedItems = [
        { title: t['feed_item1_title'], desc: t['feed_item1_desc'] },
        { title: t['feed_item2_title'], desc: t['feed_item2_desc'] },
        { title: t['feed_item3_title'], desc: t['feed_item3_desc'] },
    ];

    feedItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('feed-item');
        itemDiv.innerHTML = `
            <h4>${item.title}</h4>
            <p>${item.desc}</p>
        `;
        feedContent.appendChild(itemDiv);
    });
}


function handleMicroConsulta() {
    if (!isAuthenticated) return alert(translations[currentLanguage]['save_error_login']);
    alert(translations[currentLanguage]['micro_consulta_alert']);
    document.getElementById('oracle-alert').classList.add('alert-hidden'); 
}

function viewRewards() {
    alert(translations[currentLanguage]['rewards_alert']);
}

document.getElementById('emergencyPing').addEventListener('click', () => {
    alert(translations[currentLanguage]['ping_alert']);
});

// Inicialização da Plataforma
document.addEventListener('DOMContentLoaded', () => {
    // Adiciona os event listeners aos formulários
    document.getElementById('login-form').addEventListener('submit', login);
    document.getElementById('register-form').addEventListener('submit', register);

    // Inicializa a interface
    changeLanguage(currentLanguage); 
    updateAuthButton();
});